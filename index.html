<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>ИИ-Портрет Супер-Мозг</title>
<style>
body { font-family:sans-serif; margin:2rem; }
textarea,input,button { margin:0.5rem 0; padding:0.5rem; }
.box { background:#f9f9f9; padding:1rem; margin-top:1rem; border-radius:8px; }
</style>
</head>
<body>
<h1>ИИ-Портрет с Супер-Мозгом</h1>

<label>Портрет:</label>
<select id="portraitSelect"></select>
<input type="text" id="newPortrait" placeholder="Имя нового портрета">
<button id="addPortrait">Добавить</button><br>

<textarea id="userInput" placeholder="Введите сообщение" rows="2" cols="50"></textarea><br>
<button id="send">Отправить</button>
<button id="train">Train</button><br>

<div class="box">
  <strong>Диалог:</strong>
  <div id="dialog" style="min-height:150px;"></div>
</div>

<script>
// ======= Супер-Мозг ИИ =======
class SuperBrain {
  constructor() {
    this.memory = {}; // {тема: [{text, connections:{тема: вес}}]}
    this.context = [];
    this.themeLinks = {}; // связь тем между собой
  }

  // Учим тему
  learn(theme, text){
    if(!this.memory[theme]) this.memory[theme]=[];
    this.memory[theme].push({text, connections:{}});
  }

  // Автоопределение темы
  detectTheme(message){
    const words=message.toLowerCase().split(/\s+/);
    let bestTheme=null,maxScore=0;
    for(const [theme,phrases] of Object.entries(this.memory)){
      for(const p of phrases){
        const overlap=p.text.toLowerCase().split(/\s+/).filter(w=>words.includes(w)).length;
        if(overlap>maxScore){ maxScore=overlap; bestTheme=theme; }
      }
    }
    if(!bestTheme) bestTheme="новая_тема_"+Object.keys(this.memory).length;
    return bestTheme;
  }

  // Выбор нескольких тем для рассуждения
  selectRelatedThemes(baseTheme){
    const related=[];
    for(const t in this.themeLinks){
      if(t===baseTheme || this.themeLinks[baseTheme]?.[t]>0) related.push(t);
    }
    if(!related.includes(baseTheme)) related.push(baseTheme);
    return related;
  }

  // Генерация ответа с комбинированием тем
  respond(message){
    const baseTheme=this.detectTheme(message);
    const themes=this.selectRelatedThemes(baseTheme);

    let sentences=[];
    themes.forEach(theme=>{
      const candidates=this.memory[theme] || [];
      if(candidates.length>0){
        const chosen=candidates[Math.floor(Math.random()*candidates.length)].text;
        sentences.push(chosen);
      } else {
        sentences.push(this.simpleGenerate(theme));
      }
    });

    return sentences.join(' ');
  }

  // Простая генерация по теме
  simpleGenerate(theme){
    const words = theme.split("_");
    return "Думаю о "+words.join(" ")+".";
  }

  // Обновление связей
  updateConnections(theme,replyTheme){
    if(!this.themeLinks[theme]) this.themeLinks[theme]={};
    this.themeLinks[theme][replyTheme]=(this.themeLinks[theme][replyTheme]||0)+1;
  }

  // Контекст
  pushContext(theme,message){
    this.context.push({theme,message});
    if(this.context.length>15) this.context.shift();
  }

  // Автообучение на новых фразах
  autoLearn(message){
    const theme=this.detectTheme(message);
    if(!this.memory[theme]) this.memory[theme]=[];
    this.learn(theme,message);
  }
}

// ======= Интерфейс =======
const portraits={},portraitSelect=document.getElementById("portraitSelect"),dialogBox=document.getElementById("dialog");

function updatePortraitSelect(){
  portraitSelect.innerHTML="";
  Object.keys(portraits).forEach(name=>{
    const opt=document.createElement("option");
    opt.value=name; opt.textContent=`${name} (тем: ${Object.keys(portraits[name].brain.memory).length})`;
    portraitSelect.appendChild(opt);
  });
}

// Добавление портрета
document.getElementById("addPortrait").onclick=()=>{
  const name=document.getElementById("newPortrait").value.trim();
  if(!name) return alert("Введите имя портрета");
  if(portraits[name]) return alert("Портрет уже существует");
  portraits[name]={brain:new SuperBrain()};
  // Базовые знания
  const base=[
    {theme:"приветствия",text:"Привет!"},
    {theme:"приветствия",text:"Здравствуйте!"},
    {theme:"прощания",text:"До свидания!"},
    {theme:"шутки",text:"Почему утка пересекла дорогу? Чтобы попасть на другую сторону!"},
    {theme:"факты",text:"Солнце — это звезда."},
    {theme:"советы",text:"Отдыхайте 7–8 часов в день."}
  ];
  base.forEach(b=>portraits[name].brain.learn(b.theme,b.text));
  updatePortraitSelect();
  alert(`Портрет "${name}" добавлен`);
  document.getElementById("newPortrait").value="";
};

// Отправка сообщения
document.getElementById("send").onclick=()=>{
  const userText=document.getElementById("userInput").value.trim();
  if(!userText) return;
  const name=portraitSelect.value;
  if(!name) return alert("Выберите портрет");

  const brain=portraits[name].brain;
  appendDialog(`Вы: ${userText}`);

  const theme=brain.detectTheme(userText);
  const reply=brain.respond(userText);
  appendDialog(`${name}: ${reply}`);
  speak(reply);

  // Обновление связей и контекста
  const replyTheme=brain.detectTheme(reply);
  brain.updateConnections(theme,replyTheme);
  brain.pushContext(theme,userText);
  brain.pushContext(replyTheme,reply);

  // Автообучение
  brain.autoLearn(userText);
  brain.autoLearn(reply);

  document.getElementById("userInput").value="";
};

// Train — пользовательское обучение
document.getElementById("train").onclick=()=>{
  const userText=document.getElementById("userInput").value.trim();
  const name=portraitSelect.value;
  if(!userText) return alert("Введите сообщение для обучения");
  if(!name) return alert("Выберите портрет");
  const brain=portraits[name].brain;
  const theme=brain.detectTheme(userText);
  brain.learn(theme,userText);
  updatePortraitSelect();
  alert(`Фраза добавлена в тему "${theme}"`);
  document.getElementById("userInput").value="";
};

// Диалог
function appendDialog(text){
  dialogBox.innerHTML+=`<div>${text}</div>`;
  dialogBox.scrollTop=dialogBox.scrollHeight;
}

// Голос
function speak(text){
  if(!window.speechSynthesis) return;
  const utter=new SpeechSynthesisUtterance(text);
  utter.lang="ru-RU";
  speechSynthesis.cancel();
  speechSynthesis.speak(utter);
}
</script>
</body>
</html>
