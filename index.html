<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>ИИ-Портрет Продвинутый Мозг</title>
<style>
body { font-family:sans-serif; margin:2rem; }
textarea,input,button { margin:0.5rem 0; padding:0.5rem; }
.box { background:#f9f9f9; padding:1rem; margin-top:1rem; border-radius:8px; }
</style>
</head>
<body>
<h1>ИИ-Портрет с Продвинутым Мозгом</h1>

<label>Портрет:</label>
<select id="portraitSelect"></select>
<input type="text" id="newPortrait" placeholder="Имя нового портрета">
<button id="addPortrait">Добавить</button><br>

<textarea id="userInput" placeholder="Введите сообщение" rows="2" cols="50"></textarea><br>
<button id="send">Отправить</button>
<button id="train">Train</button><br>

<div class="box">
  <strong>Диалог:</strong>
  <div id="dialog" style="min-height:120px;"></div>
</div>

<script>
// ----- Продвинутый мозг ИИ -----
class Brain {
  constructor() {
    this.memory = {}; // {тема: [{text, connections:{тема: вес}}]}
    this.context = []; // последние сообщения
  }

  // Добавление фразы в память
  learn(theme, text){
    if(!this.memory[theme]) this.memory[theme]=[];
    this.memory[theme].push({text, connections:{}});
  }

  // Определение темы
  detectTheme(message){
    const words=message.toLowerCase().split(/\s+/);
    let bestTheme=null,maxScore=0;
    for(const [theme,phrases] of Object.entries(this.memory)){
      for(const p of phrases){
        const overlap=p.text.toLowerCase().split(/\s+/).filter(w=>words.includes(w)).length;
        if(overlap>maxScore){ maxScore=overlap; bestTheme=theme; }
      }
    }
    if(!bestTheme) bestTheme="новая_тема_"+Object.keys(this.memory).length;
    return bestTheme;
  }

  // Продвинутая генерация ответа
  respond(message){
    const theme=this.detectTheme(message);
    if(!this.memory[theme]) this.memory[theme]=[];

    // 1. Проверка на связки с контекстом
    let candidates=this.memory[theme];
    for(let i=this.context.length-1;i>=0;i--){
      const last=this.context[i];
      const linked=candidates.filter(p=>p.connections[last.theme]);
      if(linked.length>0) return linked[Math.floor(Math.random()*linked.length)].text;
    }

    // 2. Если новых фраз нет, сгенерировать комбинацию слов из темы
    if(candidates.length===0){
      return this.generateFromTheme(theme);
    }

    // 3. Иначе случайная фраза из темы
    return candidates[Math.floor(Math.random()*candidates.length)].text;
  }

  // Генерация простая из слов темы
  generateFromTheme(theme){
    const words = theme.split("_");
    let sentence="Я могу сказать: ";
    for(let i=0;i<words.length;i++){
      sentence+=words[i]+" ";
    }
    return sentence.trim()+".";
  }

  // Обновление связей
  updateConnections(theme,replyTheme){
    if(!this.memory[theme] || !this.memory[replyTheme]) return;
    this.memory[theme].forEach(p=>{
      p.connections[replyTheme]=(p.connections[replyTheme]||0)+1;
    });
  }

  // Добавляем контекст
  pushContext(theme,message){
    this.context.push({theme,message});
    if(this.context.length>10) this.context.shift(); // сохраняем последние 10 сообщений
  }

  // Автоматическое расширение памяти
  autoLearn(message){
    const words=message.split(/\s+/).filter(w=>w.length>2);
    const theme="новая_тема_"+Object.keys(this.memory).length;
    if(words.length>0) this.learn(theme,message);
  }
}

// ----- Интерфейс -----
const portraits={},portraitSelect=document.getElementById("portraitSelect"),dialogBox=document.getElementById("dialog");

function updatePortraitSelect(){
  portraitSelect.innerHTML="";
  Object.keys(portraits).forEach(name=>{
    const opt=document.createElement("option");
    opt.value=name; opt.textContent=`${name} (тем: ${Object.keys(portraits[name].brain.memory).length})`;
    portraitSelect.appendChild(opt);
  });
}

// Добавление портрета
document.getElementById("addPortrait").onclick=()=>{
  const name=document.getElementById("newPortrait").value.trim();
  if(!name) return alert("Введите имя портрета");
  if(portraits[name]) return alert("Портрет уже существует");
  portraits[name]={brain:new Brain()};
  // Базовые знания
  const base=[
    {theme:"приветствия",text:"Привет!"},
    {theme:"приветствия",text:"Здравствуйте!"},
    {theme:"прощания",text:"До свидания!"},
    {theme:"шутки",text:"Почему утка пересекла дорогу? Чтобы попасть на другую сторону!"}
  ];
  base.forEach(b=>portraits[name].brain.learn(b.theme,b.text));
  updatePortraitSelect();
  alert(`Портрет "${name}" добавлен`);
  document.getElementById("newPortrait").value="";
};

// Отправка сообщения
document.getElementById("send").onclick=()=>{
  const userText=document.getElementById("userInput").value.trim();
  if(!userText) return;
  const name=portraitSelect.value;
  if(!name) return alert("Выберите портрет");
  appendDialog(`Вы: ${userText}`);
  const brain=portraits[name].brain;

  // Автономно анализируем
  const theme=brain.detectTheme(userText);
  const reply=brain.respond(userText);
  appendDialog(`${name}: ${reply}`);
  speak(reply);

  // Связи и контекст
  brain.updateConnections(theme,brain.detectTheme(reply));
  brain.pushContext(theme,userText);
  brain.pushContext(brain.detectTheme(reply),reply);

  // Авто-расширение памяти
  brain.autoLearn(userText);

  document.getElementById("userInput").value="";
};

// Train — добавление пользовательской фразы
document.getElementById("train").onclick=()=>{
  const userText=document.getElementById("userInput").value.trim();
  const name=portraitSelect.value;
  if(!userText) return alert("Введите сообщение для обучения");
  if(!name) return alert("Выберите портрет");
  const brain=portraits[name].brain;
  const theme=brain.detectTheme(userText);
  brain.learn(theme,userText);
  updatePortraitSelect();
  alert(`Фраза добавлена в тему "${theme}"`);
  document.getElementById("userInput").value="";
};

// Диалог
function appendDialog(text){
  dialogBox.innerHTML+=`<div>${text}</div>`;
  dialogBox.scrollTop=dialogBox.scrollHeight;
}

// Голос
function speak(text){
  if(!window.speechSynthesis) return;
  const utter=new SpeechSynthesisUtterance(text);
  utter.lang="ru-RU";
  speechSynthesis.cancel();
  speechSynthesis.speak(utter);
}
</script>
</body>
</html>
